/**
 * Created by Jzk on 2014/11/6.
 */
var city_name = [ "北京" , "天津" , "河北" , "山西" , "内蒙古","辽宁","吉林","黑龙江" ,"上海","江苏","浙江","安徽","福建","江西","山东","河南","湖北","湖南","广东","广西","海南","重庆","四川","贵州","云南","西藏","陕西","甘肃","青海","宁夏","新疆"];


var population = [
    [0,14726,197071,34243,26796,37185,27021,46871,5959,26809,15643,42872,10951,15947,76089,94635,36199,20243,7036,4521,1068,9043,35430,4695,3843,300,19552,14439,1669,2509,5392],
    [3506,0,75947,9859,8504,9374,8470,17099,1046,6407,3929,11535,2698,2564,38924,24138,7842,3337,1686,1223,399,1777,7752,1813,1003,69,4684,5401,701,862,1658],
    [8809,9136,0,10398,15544,14922,10816,27755,562,5029,3473,7055,2180,2296,17267,22496,7228,3884,1302,2856,413,2250,16387,3265,2689,132,7161,4208,913,563,1489],
    [1450,979,20546,0,9065,3390,2096,2249,390,3710,2713,4377,2091,1210,6661,20480,4093,2258,591,625,227,1498,7540,1295,1619,49,5605,1339,341,167,350],
    [1407,1587,34278,21635,0,22727,13708,24807,249,3664,2137,3882,1463,1264,17446,10432,2883,1637,518,382,113,1291,8229,954,814,35,15971,14019,557,4413,329],
    [1391,1582,18044,2886,23892,0,44048,72333,854,6561,3508,8539,2348,1684,41117,14156,4260,2636,1349,703,228,1814,9366,1068,680,125,2157,1590,432,298,1004],
    [470,418,5364,961,4731,15003,0,17579,275,2287,1461,2324,755,557,32642,3299,1679,803,383,252,248,356,1615,342,299,47,532,364,222,124,336],
    [806,838,13124,1145,9535,32211,30282,0,535,4875,1571,5833,826,805,74024,6088,2010,1420,639,385,196,425,3486,526,366,40,986,938,131,113,243],
    [2842,2005,9709,6581,3608,9584,8005,13348,0,198564,73061,256915,27087,50993,44717,78298,42726,24696,7854,5545,966,22539,63111,14904,7798,180,13436,10297,1403,1409,7033],
    [1914,1302,10511,6266,2965,6278,6082,9642,12590,0,31106,262367,15200,28241,49301,96517,41510,22258,4555,5838,886,17255,71548,30793,16597,396,20847,11034,1906,1047,4212],
    [1142,713,6104,3687,2201,4347,4642,8102,8219,45546,0,242723,18625,162509,24180,127905,92269,77956,5447,16607,1030,57000,137128,152452,43106,184,19186,7424,1082,948,2231],
    [1080,522,3406,1493,800,2049,1531,1696,6326,28131,9228,0,3271,5372,7858,15448,6563,4286,1817,1343,368,1967,9499,4855,5075,105,2377,1148,513,162,706],
    [554,400,2154,1516,767,1914,1687,2600,1537,6350,10241,22983,0,88871,6733,25143,31159,22309,7620,7009,1209,35055,76908,41130,8800,137,5350,1963,329,476,815],
    [407,321,1919,1295,1044,1299,866,1039,2384,6191,13005,8784,5598,0,3193,5232,8942,14160,6799,2777,832,1465,5467,4253,1174,72,1252,1215,280,278,372],
    [1752,1596,18564,6435,8592,11904,22716,47498,1204,17577,6596,14013,4188,3136,0,27451,8465,4015,1593,1222,428,2469,11396,3226,6455,166,6277,5773,1685,945,3415],
    [1276,685,8636,5407,1246,4071,2137,3935,1219,5836,3462,8851,2001,2053,14397,0,10775,3918,1968,1259,320,1372,9205,1881,2064,196,6167,2739,887,346,1715],
    [1254,682,5417,2825,1579,3701,1937,2491,2065,7787,7070,8210,4208,7664,6467,36367,0,19875,5181,3444,973,12141,19048,3545,2468,126,5650,2145,623,357,1670],
    [644,328,2256,1088,614,1517,983,1072,676,2521,3756,3007,3149,7077,2451,5237,15712,0,9362,5484,914,2186,7133,6907,2979,127,1600,882,320,183,892],
    [2488,1585,11447,7528,3812,10243,10906,14874,2916,16613,17795,47297,46222,193541,19746,178044,245280,478115,0,358815,21715,87534,260065,90681,31262,436,46851,14584,1855,1384,4208],
    [416,359,1938,811,530,1445,1245,1828,628,2169,3574,2880,4056,4424,2150,4531,5729,24628,14796,0,2094,1888,5942,6011,2794,70,1041,545,222,135,521],
    [228,212,890,687,657,1023,1100,2205,181,1326,1278,2331,2093,3168,1310,4091,4645,7331,14496,9109,0,2040,7835,1602,924,15,970,634,162,114,476],
    [443,223,1957,1388,660,1041,673,895,889,2342,3135,1769,2551,1837,2074,3484,6081,3634,3094,1328,380,0,68247,9616,4260,207,1782,1157,391,301,1519],
    [1633,637,5340,3326,1220,6052,2568,2976,1808,5646,5862,3811,3513,3988,6097,8913,8708,6902,4932,2591,638,45965,0,7976,15512,1542,5590,4610,1706,524,3203],
    [453,286,1925,631,265,2465,900,1285,1218,3259,7237,2609,3906,3138,3617,4548,4697,15134,4959,3960,320,11497,31830,0,6549,52,1159,459,160,62,277],
    [351,277,1918,1299,413,1152,1046,1386,952,2349,4763,2477,3859,3460,2917,5293,5285,14575,2903,3302,685,13513,37499,19064,0,109,1592,729,318,137,437],
    [17,8,259,139,29,85,27,44,15,196,270,353,114,94,354,1247,643,474,42,26,8,1192,9432,172,314,0,736,2053,955,26,67],
    [1778,1029,8317,10239,4601,5389,1970,2491,1670,6583,4229,5816,2591,2229,9356,30815,7547,3664,1652,1045,336,2307,15081,1467,931,601,0,17004,1725,2591,3058],
    [747,591,4731,2066,942,3792,1415,1294,838,4059,2725,2562,919,891,5973,11952,3008,1889,561,360,137,987,6428,370,416,374,10536,0,4453,1904,2070],
    [226,165,2771,1045,355,1517,684,539,214,2271,1060,1826,473,439,3796,8616,1703,1127,210,179,27,637,5128,143,192,474,5097,9339,0,246,333],
    [309,275,3657,1296,2381,1844,604,884,326,2193,1427,2580,477,367,3835,8057,938,681,193,154,60,675,2975,196,128,20,9818,14495,295,0,317],
    [660,812,7983,3072,889,1934,1398,1933,1127,18781,3884,14924,1722,1225,22660,81772,9545,6482,1241,723,173,9303,70059,938,1049,54,18054,68336,3310,7062,0]

];


//2.转换数据，并输出转换后的数据
var chord_layout = d3.layout.chord()
    .padding(0.01)
    .sortSubgroups(d3.descending)
    .matrix(population);

console.log(chord_layout.groups());
console.log(chord_layout.chords());

//3.SVG，弦图，颜色函数的定义
var width  = 800;
var height = 800;
var innerRadius = width/2 * 0.7;
var outerRadius = innerRadius * 1.1;
//    alert(outerRadius);

var color20 = d3.scale.category20();

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(" + width/2 + "," + height/2 + ")");

//4.绘制外部弦（即分组，有多少个城市画多少个弦），及绘制城市名称
var outer_arc =  d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(outerRadius);

var g_outer = svg.append("g");

g_outer.selectAll("path")
    .data(chord_layout.groups)
    .enter()
    .append("path")
    .style("fill", function(d) { return color20(d.index); })
    .style("stroke", function(d) { return color20(d.index); })
//            .style("fill", "blue")
    .attr("d", outer_arc )
    .on("click", function(d,i){
        d.show=true;
        alert(d.show);
    });

g_outer.selectAll("text")
    .data(chord_layout.groups)
    .enter()
    .append("text")
    .each( function(d,i) {
        d.angle = (d.startAngle + d.endAngle) / 2;
        d.name = city_name[i];
    })
    .attr("dy",".35em")
    .attr("transform", function(d){
        return "rotate(" + ( d.angle * 180 / Math.PI ) + ")" +
            "translate(0,"+ -1.0*(outerRadius+10) +")" +
            ( ( d.angle > Math.PI*3/4 && d.angle < Math.PI*5/4 ) ? "rotate(180)" : "");
    })
    .text(function(d){
        return d.name;
    });


//5.绘制内部弦（即所有城市人口的来源，即有5*5=25条弧）
var inner_chord =  d3.svg.chord()
    .radius(innerRadius);

var linestobe = svg.append("g")
    .attr("class", "chord")
    .selectAll("path")
    .data(chord_layout.chords)
    .enter()
    .append("path")
    .attr("d", inner_chord )
    .style("fill", function(d) { return color20(d.source.index); })
    .style("opacity", 0.2)
    .on("mouseover",function(d,i){
        d3.select(this)
            .style("fill","red")
            .style("opacity",1);

        d3.select("#tooltip")
            .select("#name1")
            .text(city_name[d.source.index]);
        d3.select("#tooltip")
            .select("#name2")
            .text(city_name[d.target.index]);
        d3.select("#tooltip")
            .select("#name3")
            .text(city_name[d.source.index]);
        d3.select("#tooltip")
            .select("#name4")
            .text(city_name[d.target.index]);
        d3.select("#tooltip")
            .select("#name5")
            .text(city_name[d.target.index]);
        d3.select("#tooltip")
            .select("#name6")
            .text(city_name[d.source.index]);
        d3.select("#tooltip")
            .select("#num1")
            .text(d.target.value/1000);
        d3.select("#tooltip")
            .select("#num2")
            .text(d.source.value/1000);
//        d3.select("#placeholder")
//            .attr("src", "images/"+d.image);
        d3.select("#tooltip").classed("hidden", false);
    })
    .on("mouseout",function(d,i) {
        d3.select(this)
            .transition()
            .duration(500)
            .style("opacity",0.2)
            .style("fill",color20(d.source.index));
        d3.select("#tooltip").classed("hidden", true);
    });

var ticks = svg.append("g").selectAll("g")
    .data(chord_layout.groups)
    .enter().append("g").selectAll("g")
    .data(groupTicks)
    .enter().append("g")
    .attr("transform", function(d) {
        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
            + "translate(" + (outerRadius) + ",0)";
    });

ticks.append("line")
    .attr("x1", 1)
    .attr("y1", 0)
    .attr("x2", 5)
    .attr("y2", 0)
    .style("stroke", "#000");

ticks.append("text")
    .attr("x", 8)
    .attr("class","paragraph")
    .attr("dy", ".35em")
    .attr("transform", function(d) { return d.angle > Math.PI ? "rotate(180)translate(-16)" : null; })
    .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
    .text(function(d) { return d.label; });

function groupTicks(d) {
    var k = (d.endAngle - d.startAngle) / d.value;
    console.log(d.value);
    console.log(d3.range(0, d.value, 100000));
    return d3.range(0, d.value, 100000).map(function(v, i) {
        return {
            angle: v * k + d.startAngle,
            label: i % 5 ? null : v / 100000 + "百万"
        };
    });
}

//    chord_layout.on("tick", function(){
//
//        linestobe.style("opacity",function(d){
//            if (d.source.show)
//                return 1;
//            else
//                return 0.5;
//        })
//                .style("fill","yelllow")
//    });
//

/**
 * Created by Jzk on 2014/11/6.
 */
